# .github/workflows/main.yml
# Este arquivo define um workflow do GitHub Actions para implantação contínua no Netlify.

name: Deploy Sabor & Vida to Netlify - Final

on:
  push:
    branches:
      - main # O deploy será acionado sempre que houver um push na branch 'main'

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest # O job será executado em uma máquina virtual Ubuntu

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4 # Clona o repositório do GitHub na máquina virtual

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18' # Use a versão do Node.js compatível com seu projeto React/Vite

      - name: Install Dependencies
        run: npm install # Instala as dependências do seu projeto (pacotes npm)

      - name: Build Project
        # Comando de build para projetos Vite (geralmente `npm run build` que executa `vite build`)
        run: npm run build
        env:
          # Variáveis de ambiente do Supabase e Stripe (apenas as publicáveis para o build do frontend)
          # Para Vite, as variáveis de ambiente precisam ser prefixadas com VITE_ para serem expostas ao frontend.
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          # A SECRET_KEY do Stripe NUNCA deve estar aqui, apenas nas variáveis de ambiente do Netlify para funções serverless.

      # --- Linkar o Projeto Netlify ao Repositório ---
      - name: Link Netlify Project
        run: netlify link --id ${{ secrets.NETLIFY_SITE_ID }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }} # Necessário para autenticar o link

      - name: Deploy to Netlify
        uses: netlify/actions/cli@master # Usa a action oficial do Netlify CLI
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }} # Seu token Netlify
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}     # Seu ID do site Netlify
        with:
          args: deploy --prod --dir=dist # Comando de deploy para produção, apontando para a pasta dist

      # Variáveis de ambiente que estarão disponíveis durante o runtime no Netlify (funções serverless, etc.)
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
        STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
        YOUR_DOMAIN: ${{ secrets.YOUR_DOMAIN }} # Sua URL de domínio
